<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Section 1 ¬∑ Project Overview</title>
  <meta name="description" content="Overview, milestones, and responsibilities for the histological kidney tissue project.">

  <style>
    :root {
      --bg:#ffffff;
      --text:#111111;
      --muted:#444444;
      --border:#dddddd;
      --accent:#004aad;
      --radius:14px;

      /* Sidebar tokens (match previous layout) */
      --sidebar-w: 300px;
      --sidebar-bg: #1f2328;
      --sidebar-bg-2: #14171b;
      --sidebar-text: rgba(255,255,255,0.92);
      --sidebar-muted: rgba(255,255,255,0.62);
      --sidebar-active: rgba(255,255,255,0.12);
      --sidebar-hover: rgba(255,255,255,0.08);
      --sidebar-divider: rgba(255,255,255,0.10);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* ===== Layout: sidebar + content ===== */
    .layout{
      display:flex;
      min-height:100vh;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:var(--sidebar-w);
      background:linear-gradient(180deg,var(--sidebar-bg),var(--sidebar-bg-2));
      color:var(--sidebar-text);
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      border-right:1px solid rgba(0,0,0,0.15);
    }
    .sidebar-header{
      padding:22px 20px 14px;
      border-bottom:1px solid var(--sidebar-divider);
    }
    .sidebar-title{
      font-size:22px;
      font-weight:750;
      margin:0;
      letter-spacing:.2px;
    }
    .sidebar-subtitle{
      margin:6px 0 0 0;
      color:var(--sidebar-muted);
      font-size:13px;
    }

    .side-nav{padding:10px 0;}
    .side-nav a{
      display:flex;
      align-items:center;
      gap:12px;

      padding:14px 18px;
      color:var(--sidebar-muted);
      text-decoration:none;

      border-top:1px solid rgba(255,255,255,0.03);
      border-bottom:1px solid rgba(0,0,0,0.12);
      transition:background .15s,color .15s;
    }
    .side-nav a:hover{
      background:var(--sidebar-hover);
      color:var(--sidebar-text);
      text-decoration:none;
    }
    .side-nav a.active{
      background:var(--sidebar-active);
      color:var(--sidebar-text);
    }
    .nav-ico{
      width:26px;height:26px;
      display:inline-grid;place-items:center;
      border-radius:8px;
      color:var(--sidebar-muted);
      flex:0 0 26px;
      font-size:16px;
    }
    .side-nav a.active .nav-ico{
      color:#ff6b8a;
    }
    .nav-text{
      font-size:15px;
      letter-spacing:.2px;
    }

    /* ===== Content ===== */
    .content{
      flex:1;
      background:var(--bg);
    }
    main{max-width:1100px;margin:0 auto;padding:30px 16px 60px;}
    h1{font-size:28px;margin-top:0;color:var(--accent);}
    h2{margin-top:28px;font-size:22px;color:var(--accent);}
    p{margin:10px 0;}

    section.content-block{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      padding:24px 20px;
      margin-top:22px;
    }

    .image-block{
      text-align:center;
      margin-top:14px;
    }
    .image-block img{
      max-width:100%;
      height:auto;
      border-radius:var(--radius);
      box-shadow:0 4px 14px rgba(0,0,0,0.1);
    }

    /* keep your rotation helpers */
    .rotate-90{
      transform:rotate(270deg);
      transform-origin:center;
    }
    .rotate--90{
      transform:rotate(-90deg);
      transform-origin:center;
    }

    footer{
      border-top:1px solid var(--border);
      color:var(--muted);
      text-align:center;
      padding:18px 0;
      font-size:14px;
      margin-top:40px;
    }

    /* ===== Responsive: collapse sidebar to top ===== */
    @media (max-width: 900px){
      .layout{flex-direction:column;}
      .sidebar{
        width:100%;
        height:auto;
        position:relative;
      }
      .side-nav{
        display:grid;
        grid-template-columns:1fr 1fr;
      }
      .side-nav a{
        border:none;
        border-top:1px solid var(--sidebar-divider);
      }
    }

    /* ===== Book shelf ===== */
    .shelf-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:14px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
    }
    .shelf-note{
      color:var(--muted);
      font-size:14px;
      margin:0;
    }
    .shelf-search{
      display:flex;
      gap:10px;
      align-items:center;
      margin-left:auto;
    }
    .search-input{
      width:min(360px, 75vw);
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--text);
    }

    .shelf-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 1100px){
      .shelf-grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 760px){
      .shelf-grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 420px){
      .shelf-grid{ grid-template-columns:1fr; }
    }

    .book{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      display:flex;
      flex-direction:column;
      min-height:260px;
    }
    .book:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 26px rgba(0,0,0,0.10);
    }
    .cover{
      position:relative;
      background:linear-gradient(180deg, #f7f9ff, #ffffff);
      padding:12px;
      border-bottom:1px solid var(--border);
      aspect-ratio: 3 / 4;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cover canvas{
      width:100%;
      height:100%;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.06);
    }
    .badge{
      position:absolute;
      top:10px;
      left:10px;
      font-size:12px;
      color:#fff;
      background:var(--accent);
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
    }

    .book-body{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .book-title{
      margin:0;
      font-weight:700;
      font-size:14px;
      line-height:1.35;
    }
    .book-sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    /* ===== Modal reader ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:999;
    }
    .modal.open{ display:block; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.55);
    }
    .modal-panel{
      position:relative;
      width:min(1100px, 92vw);
      height:min(86vh, 860px);
      margin:6vh auto 0;
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
    }
    .modal-topbar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    .modal-title{
      font-weight:750;
      font-size:14px;
      margin:0;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:46vw;
    }
    .modal-spacer{ flex:1; }
    .iconbtn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
    }
    .iconbtn:hover{ background:#f7f7f7; }

    .readerbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:#fafafa;
    }
    .readerbar .meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:6px;
      padding:0 6px;
    }
    .readerbar input{
      width:72px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      outline:none;
      background:#fff;
    }
    .reader{
      flex:1;
      overflow:auto;
      background:#f3f3f3;
      padding:14px;
    }
    .reader-inner{
      display:flex;
      justify-content:center;
    }
    #pdfCanvas{
      background:#fff;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 10px 26px rgba(0,0,0,0.14);
    }

    @media (max-width: 520px){
      .modal-title{ max-width:56vw; }
      .readerbar{ gap:6px; }
      .iconbtn{ padding:9px 10px; }
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title">üìÅ My Project</h1>
        <p class="sidebar-subtitle">Histology workflow ¬∑ Nephrocalcinosis</p>
      </div>

      <nav class="side-nav">
        <a href="./index.html">
          <span class="nav-ico">‚Ü©Ô∏è</span>
          <span class="nav-text">Back to Index</span>
        </a>
        <a href="./part-1.html" class="active">
          <span class="nav-ico">üè†</span>
          <span class="nav-text">Photo</span>
        </a>
        <a href="./part-3.html">
          <span class="nav-ico">‚úçÔ∏è</span>
          <span class="nav-text">Activity</span>
        </a>
        <a href="./part-4.html">
          <span class="nav-ico">üìÑ</span>
          <span class="nav-text">Experiment Report</span>
        </a>
      </nav>
    </aside>

    <!-- RIGHT CONTENT -->
    <div class="content">
      <main>
        <h1>Section 1 ¬∑ Project Overview</h1>
        <p style="color:var(--muted)">Treatment and workflow with histological kidney tissue affected by nephrocalcinosis.</p>

        <section class="content-block">
          <h2>Treatment and Work with Histological Kidney Tissue Affected by Nephrocalcinosis</h2>
          <p>
            The project documents a complete workflow for handling kidney tissue influenced by nephrocalcinosis ‚Äî from fixation to microscopic assessment ‚Äî focusing on preserving tissue integrity and diagnostic value throughout processing.
          </p>
        </section>

        <section class="content-block">
          <h2>Fixation</h2>
          <p>
            Tissue that is extracted from an organism must be immediately fixed to prevent damage caused by internal and external factors, such as the onset of putrefaction. Shown here is how the tissue was delivered, fully fixed, and prepared before macroscopic examination and assessment.
          </p>
          <div class="image-block">
            <img src="image/2.png" alt="Fixation step image" class="rotate-90">
          </div>
        </section>

        <section class="content-block">
          <h2>Macroscopic Assessment and Trimming</h2>
          <p>
            The tissue material is assessed for consistency, color, and size ‚Äî this evaluation is part of the diagnostic process. The kidney tissue is sliced so that, under microscopy, relevant components can be observed in each section. The slices are oriented and placed in labeled cassettes, with detailed information systematically recorded.
          </p>
          <div class="image-block">
            <img src="image/3.png" alt="Macroscopic assessment image">
          </div>
        </section>

        <section class="content-block">
          <h2>Feeding (Tissue Processing)</h2>
          <p>
            The tissue was processed using the <strong>SPIN TISSUE PROCESSOR STP10</strong>. This step prepares it for paraffin embedding. For successful embedding, tissue must become permeable to paraffin ‚Äî achieved through formalin fixation, dehydration, clearing in xylene, and final paraffin impregnation.
          </p>
          <div class="image-block">
            <img src="image/4.png" alt="Feeding process image" class="rotate--90">
          </div>
        </section>

        <section class="content-block">
          <h2>Paraffin Embedding</h2>
          <p>
            Once permeable, tissue slices can be embedded in paraffin using the <strong>MEDITE TBS88 ‚Äì Paraffin Embedding System</strong>. After the paraffin in the chamber has melted, a mold is selected based on tissue size, a small amount of paraffin is poured, and the tissue is properly oriented. The mold is then moved to a cold plate to accelerate solidification while pressing the tissue to ensure the surface adheres. The labeled cassette with ID is attached, and the entire mold is placed on a larger cold plate until fully solidified.
          </p>
          <div class="image-block">
            <img src="image/5.png" alt="Paraffin embedding image">
          </div>
        </section>

        <section class="content-block">
          <h2>Sectioning</h2>
          <p>
            The finished paraffin blocks are trimmed to ensure that each section includes the full tissue surface. Trimming requirements vary per block. Various microtomes ‚Äî manual or with water slides ‚Äî are used. Precision and patience are essential for clean, even sections. For disease-affected samples, extra care is taken to avoid tearing and ensure complete component preservation. The sections are floated on a water bath, mounted on slides, and placed on a warming plate for adhesion.
          </p>
          <div class="image-block">
            <img src="image/6.png" alt="Sectioning process image">
          </div>
        </section>

        <section class="content-block">
          <h2>Staining</h2>
          <p>
            To visualize tissue components under the microscope, an appropriate staining method is chosen. <strong>HE/HES</strong> is a common stain that differentiates layers and structures, providing clear contrast between various cell and tissue types.
          </p>
          <div class="image-block">
            <img src="image/7.png" alt="Staining process image">
          </div>
        </section>

        <section class="content-block">
          <h2>Microscopic Assessment</h2>
          <p>
            During microscopic examination, normal histology is identified ‚Äî including tissue architecture, cell types, and characteristic structures. Abnormal findings such as tissue damage, inflammatory or blood cells, and necrosis are also evaluated, as these indicate pathological changes absent in healthy tissue.
          </p>
          <div class="image-block">
            <img src="image/8.png" alt="Microscopic assessment image">
          </div>
        </section>

        <!-- ===== Book-style PDF shelf ===== -->
        <section class="content-block">
          <h2>Document Library</h2>
          <p style="color:var(--muted)">
            Browse the documents like a bookshelf. Click a cover to open the PDF reader.
          </p>

          <div class="shelf-toolbar">
            <p class="shelf-note">Tip: Put PDFs under <strong>./docs/</strong>. Word files should be converted to PDF for paging.</p>
            <div class="shelf-search">
              <input id="searchInput" class="search-input" type="search" placeholder="Search documents by name...">
            </div>
          </div>

          <div id="shelfGrid" class="shelf-grid"></div>
        </section>
      </main>

      <footer>
        ¬© <span id="year"></span> My Project ‚Äì All rights reserved.
      </footer>
    </div>
  </div>

  <!-- ===== Modal Reader ===== -->
  <div id="pdfModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>

    <div class="modal-panel" role="dialog" aria-modal="true" aria-label="PDF reader">
      <div class="modal-topbar">
        <p id="modalTitle" class="modal-title">Document</p>
        <div class="modal-spacer"></div>
        <a id="downloadLink" class="iconbtn" href="#" download>Download</a>
        <button id="closeModal" class="iconbtn" type="button">Close</button>
      </div>

      <div class="readerbar">
        <button id="prevPage" class="iconbtn" type="button">Prev</button>
        <button id="nextPage" class="iconbtn" type="button">Next</button>

        <span class="meta">
          Page
          <input id="pageNumber" type="number" min="1" value="1">
          /
          <span id="pageCount">‚Äì</span>
        </span>

        <button id="zoomOut" class="iconbtn" type="button">‚àí</button>
        <button id="zoomIn" class="iconbtn" type="button">+</button>
        <button id="fitWidth" class="iconbtn" type="button">Fit</button>
        <button id="fullscreen" class="iconbtn" type="button">Full screen</button>
      </div>

      <div class="reader" id="viewerWrap">
        <div class="reader-inner">
          <canvas id="pdfCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Keep your original footer year script -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- PDF.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>

  <script>
    // ====== Configure your documents here (PDF only for best "book" + paging) ======
    // Put your PDFs under: ./docs/
    const DOCS = [
      { title: "Experiment Report", file: "docs/Siluxin.pdf", subtitle: "PDF" },
      { title: "Protocol ‚Äì Nephrocalcinosis", file: "docs/Siluxin.pdf", subtitle: "PDF" },
      { title: "Microscopy Notes", file: "docs/Siluxin.pdf", subtitle: "PDF" }
    ];

    // ====== PDF.js setup ======
    const { pdfjsLib } = globalThis;
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";

    // ====== Shelf DOM ======
    const shelfGrid = document.getElementById("shelfGrid");
    const searchInput = document.getElementById("searchInput");

    // ====== Modal DOM ======
    const modal = document.getElementById("pdfModal");
    const modalTitle = document.getElementById("modalTitle");
    const closeModalBtn = document.getElementById("closeModal");
    const downloadLink = document.getElementById("downloadLink");

    const viewerWrap = document.getElementById("viewerWrap");
    const pdfCanvas = document.getElementById("pdfCanvas");
    const ctx = pdfCanvas.getContext("2d");

    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const zoomOutBtn  = document.getElementById("zoomOut");
    const zoomInBtn   = document.getElementById("zoomIn");
    const fitWidthBtn = document.getElementById("fitWidth");
    const fullscreenBtn = document.getElementById("fullscreen");

    const pageNumberInput = document.getElementById("pageNumber");
    const pageCountSpan = document.getElementById("pageCount");

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.15;
    let rendering = false;
    let pendingPage = null;
    let activeIndex = -1;

    // ====== Utilities ======
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function openModal() {
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      // Optional: release pdfDoc to reduce memory
      pdfDoc = null;
      ctx.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
    }

    function clampPage(n) {
      if (!pdfDoc) return 1;
      return Math.min(Math.max(1, n), pdfDoc.numPages);
    }

    function queueRenderPage(num) {
      if (rendering) pendingPage = num;
      else renderPage(num);
    }

    async function renderPage(num) {
      rendering = true;
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale });

      const outputScale = window.devicePixelRatio || 1;
      pdfCanvas.width = Math.floor(viewport.width * outputScale);
      pdfCanvas.height = Math.floor(viewport.height * outputScale);
      pdfCanvas.style.width = Math.floor(viewport.width) + "px";
      pdfCanvas.style.height = Math.floor(viewport.height) + "px";

      const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;
      await page.render({ canvasContext: ctx, viewport, transform }).promise;

      rendering = false;
      if (pendingPage !== null) {
        const p = pendingPage;
        pendingPage = null;
        await renderPage(p);
      }
    }

    function goToPage(n) {
      if (!pdfDoc) return;
      pageNum = clampPage(n);
      pageNumberInput.value = String(pageNum);
      queueRenderPage(pageNum);
    }

    function fitToWidth() {
      if (!pdfDoc) return;
      pdfDoc.getPage(pageNum).then(page => {
        const wrapWidth = viewerWrap.clientWidth - 28;
        const unscaled = page.getViewport({ scale: 1 });
        scale = Math.max(0.5, Math.min(3.0, wrapWidth / unscaled.width));
        queueRenderPage(pageNum);
      });
    }

    // ====== Load doc into modal reader ======
    async function loadIntoReader(index) {
      const doc = DOCS[index];
      if (!doc) return;

      activeIndex = index;
      modalTitle.textContent = doc.title;
      downloadLink.href = doc.file;

      openModal();

      pdfDoc = await pdfjsLib.getDocument(doc.file).promise;
      pageNum = 1;

      pageCountSpan.textContent = String(pdfDoc.numPages);
      pageNumberInput.max = String(pdfDoc.numPages);
      pageNumberInput.value = "1";

      await renderPage(pageNum);
      fitToWidth();
    }

    // ====== Build shelf (covers) ======
    function buildShelf(list) {
      shelfGrid.innerHTML = "";

      if (!list.length) {
        shelfGrid.innerHTML = `<div style="grid-column:1/-1;color:var(--muted);padding:10px 2px;">
          No documents found.
        </div>`;
        return;
      }

      list.forEach((doc, idx) => {
        const card = document.createElement("div");
        card.className = "book";
        card.setAttribute("role", "button");
        card.setAttribute("tabindex", "0");
        card.dataset.index = String(doc.__index);

        card.innerHTML = `
          <div class="cover">
            <span class="badge">PDF</span>
            <canvas id="cover-${doc.__index}" aria-label="Cover preview"></canvas>
          </div>
          <div class="book-body">
            <p class="book-title">${escapeHtml(doc.title)}</p>
            <p class="book-sub">${escapeHtml(doc.subtitle || "Document")}</p>
          </div>
        `;

        card.addEventListener("click", () => loadIntoReader(doc.__index));
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            loadIntoReader(doc.__index);
          }
        });

        shelfGrid.appendChild(card);

        // Render first-page thumbnail into the cover canvas
        renderCoverThumbnail(doc, `cover-${doc.__index}`).catch(() => {
          // If thumbnail fails (e.g., file not found), keep empty
        });
      });
    }

    async function renderCoverThumbnail(doc, canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const cctx = canvas.getContext("2d");

      // Load just for thumbnail (separate task)
      const thumbPdf = await pdfjsLib.getDocument(doc.file).promise;
      const page = await thumbPdf.getPage(1);

      // We want a "book cover" look: fill the canvas area
      const targetW = 360;
      const targetH = 480;

      canvas.width = targetW * (window.devicePixelRatio || 1);
      canvas.height = targetH * (window.devicePixelRatio || 1);
      canvas.style.width = "100%";
      canvas.style.height = "100%";

      const dpr = window.devicePixelRatio || 1;
      cctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Compute scale to fit inside target box
      const unscaled = page.getViewport({ scale: 1 });
      const scaleFit = Math.min(targetW / unscaled.width, targetH / unscaled.height);
      const viewport = page.getViewport({ scale: scaleFit });

      // Clear & center
      cctx.clearRect(0, 0, targetW, targetH);
      const offsetX = (targetW - viewport.width) / 2;
      const offsetY = (targetH - viewport.height) / 2;

      // White page background
      cctx.fillStyle = "#fff";
      cctx.fillRect(0, 0, targetW, targetH);

      await page.render({
        canvasContext: cctx,
        viewport,
        transform: [1, 0, 0, 1, offsetX, offsetY]
      }).promise;

      // Hint of "spine" shadow for book feel
      cctx.fillStyle = "rgba(0,0,0,0.06)";
      cctx.fillRect(0, 0, 10, targetH);

      // Release
      thumbPdf.destroy();
    }

    // ====== Search ======
    function applySearch() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const filtered = DOCS
        .map((d, i) => ({ ...d, __index: i }))
        .filter(d => d.title.toLowerCase().includes(q));
      buildShelf(filtered);
    }

    searchInput.addEventListener("input", applySearch);

    // ====== Reader controls ======
    prevPageBtn.addEventListener("click", () => goToPage(pageNum - 1));
    nextPageBtn.addEventListener("click", () => goToPage(pageNum + 1));
    pageNumberInput.addEventListener("change", () => goToPage(Number(pageNumberInput.value)));

    zoomOutBtn.addEventListener("click", () => { scale = Math.max(0.5, scale - 0.1); queueRenderPage(pageNum); });
    zoomInBtn.addEventListener("click", () => { scale = Math.min(3.0, scale + 0.1); queueRenderPage(pageNum); });
    fitWidthBtn.addEventListener("click", fitToWidth);

    fullscreenBtn.addEventListener("click", async () => {
      const panel = document.querySelector(".modal-panel");
      if (!document.fullscreenElement) {
        await panel.requestFullscreen();
        setTimeout(fitToWidth, 150);
      } else {
        await document.exitFullscreen();
      }
    });

    // ====== Modal closing ======
    closeModalBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.dataset && t.dataset.close === "1") closeModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
    });
    window.addEventListener("resize", () => {
      if (modal.classList.contains("open") && pdfDoc) fitToWidth();
    });

    // ====== Init ======
    // Add internal indices to DOCS for stable references
    applySearch();
  </script>
</body>
</html>
